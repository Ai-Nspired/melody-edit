<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Truth Engine Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/lib/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/github-dark.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Merriweather:wght@300;700&family=Cutive+Mono&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* Your existing styles + additions */
        :root {
            --bg-color: #1e1e1e;
            --text-color: #f0f0f0;
            --border-color: #d4c4a8;
            --modal-bg: #2a2a2a;
            --input-bg: #1a1a1a;
            --button-bg: #d4c4a8;
            --accent: #d4c4a8;
            --success: #00ff8c;
            --highlight: #d4c4a8;
            --warning: #ffab00;
            --glow: rgba(212, 196, 168, 0.6);
            --melody-note: #d4c4a8;
            --melody-note-active: #00ff8c;
            --output-bg-color: #f8f8ff;
            --output-text-color: #1a1a1a;
            --output-secondary-text: #6c757d;
            --output-accent-color: #1a2a3a;
            --truth-accent-light: #0cf;
            --truth-positive: #00ff8c;
            --truth-warning: #ff5050;
            --block-text-normal: #f0f0f0;
            --block-source-bg: rgba(26, 42, 58, 0.5);
            --block-memo-bg: rgba(0, 71, 171, 0.2);
            --block-blueprint-bg: rgba(0, 255, 136, 0.1);
            --block-logic-bg: #111b2c;
            --block-spy-ink-bg: #000000;
        }

        [data-output-mode="dark"] {
            --output-bg-color: #1a1a1a;
            --output-text-color: #f0f0f0;
            --output-secondary-text: #9fa8da;
            --output-accent-color: #c7a17a;
            --block-text-normal: #e5f7ff;
        }
        [data-output-mode="neo"] {
            --output-bg-color: #000000;
            --output-text-color: #00FF00;
            --output-secondary-text: #00AA00;
            --output-accent-color: #00FF00;
            --block-text-normal: #00FF00;
        }

        * { box-sizing: border-box; transition: all .3s ease; }
        
        body {
            background: var(--bg-color);
            color: var(--text-color);
            font-family: 'Merriweather', serif;
            font-size: 1rem;
            margin: 0;
            padding: 2rem 1rem;
            min-height: 100vh;
            box-sizing: border-box;
            line-height: 1.6;
            text-align: center;
            background-image: url('https://www.transparenttextures.com/patterns/dark-matter.png');
        }
        
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--modal-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 5px 15px var(--glow);
        }
        
        h1 {
            color: var(--text-color);
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
            text-align: center;
            letter-spacing: 0.1em;
            text-shadow: 0 0 10px var(--glow);
        }

        /* NEW: API Status Indicator */
        #api-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--input-bg);
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid var(--accent);
            z-index: 1000;
            font-family: 'Cutive Mono', monospace;
            font-size: 0.85rem;
        }

        #api-status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--warning);
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        #api-status.online #api-status-indicator {
            background: var(--success);
            animation: none;
        }

        #api-status.offline #api-status-indicator {
            background: #ff3700;
            animation: none;
        }

        /* MELODY LOCK SCREEN (your existing styles) */
        #melody-lock {
            padding: 2rem 1rem;
            border: 2px solid var(--accent);
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .melody-instructions {
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 1.08em;
            border-radius: 7px;
            padding: 10px 14px;
            margin-bottom: 16px;
            margin-top: 10px;
            border-left: 4px solid var(--accent);
            text-align: left;
            max-width: 420px;
            margin-left: auto;
            margin-right: auto;
        }
        
        #piano-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin: 1rem 0;
            padding: 1rem;
            background: var(--input-bg);
            border-radius: 8px;
            border: 1px solid var(--accent);
        }
        
        .note-btn {
            height: 50px;
            border: 2px solid var(--accent);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 8px var(--glow);
            color: #000;
            transition: all .2s ease;
            background: linear-gradient(145deg, #f8f8f8 0%, #e8e8e8 100%);
            font-family: 'Cutive Mono', monospace;
        }
        
        .note-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 0 10px var(--glow);
        }
        
        .note-btn.active {
            background: var(--success);
            color: #1e1e1e;
            transform: scale(0.98);
            box-shadow: 0 0 15px var(--success);
        }

        /* NEW: Melody Management Styles */
        .melody-management-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .melody-level-card {
            background: var(--input-bg);
            border: 2px solid var(--accent);
            border-radius: 10px;
            padding: 1.5rem;
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        .melody-level-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), var(--success));
        }

        .melody-level-title {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            color: var(--accent);
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .melody-level-desc {
            color: var(--output-secondary-text);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.4;
        }

        .melody-hash-display {
            background: #0a0a0a;
            padding: 10px;
            border-radius: 6px;
            font-family: 'Cutive Mono', monospace;
            font-size: 0.8rem;
            color: var(--success);
            word-break: break-all;
            margin-bottom: 1rem;
            border: 1px solid var(--accent);
        }

        .melody-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* NEW: Individual Sovereign Melody Creator */
        .sovereign-creator {
            background: var(--input-bg);
            border: 2px solid var(--success);
            border-radius: 10px;
            padding: 2rem;
            margin: 2rem 0;
            text-align: left;
        }

        .sovereign-creator h3 {
            color: var(--success);
            font-family: 'Cinzel', serif;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .sovereign-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .sovereign-field {
            display: flex;
            flex-direction: column;
        }

        .sovereign-field label {
            color: var(--border-color);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .sovereign-field input {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-color);
            font-family: inherit;
        }

        .compact-piano {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 6px;
            margin: 1rem 0;
            padding: 1rem;
            background: #0a0a0a;
            border-radius: 8px;
            border: 1px solid var(--success);
        }

        .compact-note {
            height: 40px;
            border: 1px solid var(--success);
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all .2s;
            background: linear-gradient(145deg, #1a1a1a, #0a0a0a);
            color: var(--accent);
        }

        .compact-note:hover {
            background: var(--success);
            color: #1a1a1a;
            transform: scale(1.05);
        }

        .compact-note.active {
            background: var(--success);
            color: #1e1a1a;
            box-shadow: 0 0 10px var(--success);
        }

        /* Your existing styles continue... */
        .melodybar {
            margin: 0.5em 0;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
        }

        .melodynote {
            display: inline-block;
            background: var(--melody-note);
            color: #1e1e1e;
            font-weight: bold;
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 15px;
            margin: 2px;
            box-shadow: 0 1px 3px var(--glow);
            transition: all .15s;
            animation: pulse 0.3s ease-out;
        }

        .melodynote.playing {
            background: var(--melody-note-active);
            box-shadow: 0 0 10px var(--melody-note-active);
        }

        /* ADMIN INTERFACE (your existing styles) */
        #admin-interface {
            display: none;
        }

        nav.tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 2rem;
        }
        
        nav.tabs a {
            padding: 0.8rem 1.2rem;
            text-decoration: none;
            color: var(--text-color);
            font-family: 'Cutive Mono', monospace;
            font-size: 0.9rem;
            border-right: 1px solid var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        nav.tabs a:hover,
        nav.tabs a:focus {
            background-color: rgba(212, 196, 168, 0.1);
            box-shadow: 0 0 5px var(--glow);
        }
        
        nav.tabs a.active {
            background-color: var(--border-color);
            color: #1e1e1e;
        }
        
        .content-pane {
            display: none;
            padding: 1.5rem 0;
            animation: fadeIn 0.5s ease;
        }
        
        .content-pane.active {
            display: block;
        }

        /* Form elements (existing styles) */
        label {
            display: block;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--border-color);
            text-align: left;
        }
        
        input[type="text"], textarea, select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-color);
            font-family: inherit;
            font-size: 0.9rem;
            box-sizing: border-box;
            margin-bottom: 0.5rem;
            outline: none;
            transition: border 0.3s ease;
            text-align: left;
        }
        
        input[type="text"]:focus, textarea:focus, select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 5px var(--glow);
        }
        
        textarea {
            min-height: 200px;
            font-family: 'Cutive Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        button {
            background: var(--button-bg);
            color: #1e1e1e;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 0.9rem;
            font-family: 'Cutive Mono', monospace;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 700;
        }

        button.accent {
            background: var(--accent);
        }
        
        button.success {
            background: var(--success);
            color: #1e1e1e;
        }

        .status-message {
            margin: 1rem 0;
            padding: 0.8rem;
            background: rgba(212, 196, 168, 0.1);
            border-radius: 4px;
            border-left: 3px solid var(--button-bg);
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            text-align: left;
        }
        
        .status-message.show {
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-container {
                padding: 1rem;
            }
            
            nav.tabs a {
                padding: 0.6rem;
                font-size: 0.8rem;
            }
            
            .melody-management-grid {
                grid-template-columns: 1fr;
            }
            
            .sovereign-form {
                grid-template-columns: 1fr;
            }
            
            #api-status {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 1rem;
            }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body data-output-mode="silvery">
    <!-- NEW: API Status Indicator -->
    <div id="api-status">
        <span id="api-status-indicator"></span>
        <span id="api-status-text">Checking...</span>
    </div>

    <div class="admin-container">
        <h1>eitl truth editor</h1>
        
        <!-- MELODY LOCK SCREEN -->
        <div id="melody-lock">
            <h2 style="color: var(--accent); font-family: 'Cinzel', serif; margin-top: 0;">ACCESS PROTOCOL</h2>
            
            <div class="melody-instructions">
                <b>Unlock Protocol:</b> Play the melody that matches the hardcoded hash. Generate melody/pattern in <a href="aincipher.html" style="color: var(--success)">ai-n cipher</a>.<br>
                <div style="font-size: 0.95em; margin-top: 7px; opacity: 0.87;">
                    <strong>Status:</strong> <span id="current-hash-display" style="font-family: 'Cutive Mono', monospace;">Waiting for input...</span>
                </div>
            </div>
            
            <div id="piano-grid"></div>
            
            <div class="melody-controls button-group">
                <button id="clearMelody">Clear Melody</button>
                <button id="playMelody">Play Melody</button>
                <button id="unlockAdmin" class="success">Unlock Admin</button>
            </div>
            
            <div class="melodybar" id="melodyBar"></div>
            
            <div class="import-group">
                <input type="text" id="importMelodyInput" placeholder="Pattern e.g. 1o-1q-1s">
                <button id="importMelodyBtn">Import Pattern</button>
            </div>
            
            <div id="melody-status"></div>
        </div>
        
        <!-- MAIN ADMIN INTERFACE -->
        <div id="admin-interface">
            <nav class="tabs" id="main-tabs">
                <a href="#" class="active" data-tab="query">Query Editor</a>
                <a href="#" data-tab="melody-mgmt">Melody Management</a>
                <a href="#" data-tab="sovereign">Create Sovereign Melody</a>
                <a href="#" data-tab="preview">Preview Mode</a>
                <a href="#" data-tab="snippets">HTML View & Extractor</a>
                <a href="#" data-tab="microsite">Microsite Snippets</a>
                <a href="#" data-tab="library">Query Library</a>
            </nav>

            <!-- Melody Management Tab (NEW) -->
            <div id="melody-mgmt" class="content-pane">
                <h3 style="color: var(--accent); font-family: 'Cinzel', serif;">Melody Authentication System</h3>
                <p style="text-align: left; margin-bottom: 2rem;">Manage access levels for your truth engine. Each melody level provides different access rights.</p>
                
                <div class="melody-management-grid">
                    <div class="melody-level-card">
                        <div class="melody-level-title">üîì Master Melody</div>
                        <div class="melody-level-desc">
                            System-wide access. Full administrative privileges across all content and users.
                        </div>
                        <div class="melody-hash-display" id="master-hash">
                            0459c722cb13f0b60b640c4795640bcba0dcfdbc56532fa26ab5ada3a9ed2edf
                        </div>
                        <div class="melody-controls">
                            <button onclick="copyHash('master-hash')">Copy Hash</button>
                            <button onclick="playMelodyFromHash('master')">Play</button>
                            <button onclick="rotateMelody('master')">Rotate</button>
                        </div>
                    </div>

                    <div class="melody-level-card">
                        <div class="melody-level-title">üè¢ Administrative Melody</div>
                        <div class="melody-level-desc">
                            Group/organization access. Content management within assigned domains.
                        </div>
                        <div class="melody-hash-display" id="admin-hash">
                            Not yet configured
                        </div>
                        <div class="melody-controls">
                            <button onclick="copyHash('admin-hash')">Copy Hash</button>
                            <button onclick="playMelodyFromHash('admin')">Play</button>
                            <button onclick="rotateMelody('admin')">Rotate</button>
                        </div>
                    </div>

                    <div class="melody-level-card">
                        <div class="melody-level-title">üë§ Individual Sovereign Melody</div>
                        <div class="melody-level-desc">
                            Personal narrative control. 4-8 note melodies for easy memorization.
                        </div>
                        <div class="melody-hash-display" id="personal-hash">
                            Generated per user
                        </div>
                        <div class="melody-controls">
                            <button onclick="copyHash('personal-hash')">Copy Hash</button>
                            <button onclick="playMelodyFromHash('personal')">Play</button>
                            <button onclick="showSovereignCreator()">Create New</button>
                        </div>
                    </div>
                </div>

                <div class="status-message" id="melody-mgmt-status"></div>
            </div>

            <!-- Create Sovereign Melody Tab (NEW) -->
            <div id="sovereign" class="content-pane">
                <div class="sovereign-creator">
                    <h3>Create Your Individual Sovereign Melody</h3>
                    <p style="text-align: center; color: var(--output-secondary-text); margin-bottom: 2rem;">
                        Design a 4-8 note melody that resonates with you. This becomes your personal authentication key.
                    </p>

                    <div class="sovereign-form">
                        <div class="sovereign-field">
                            <label for="sovereign-name">Your Name/Identifier:</label>
                            <input type="text" id="sovereign-name" placeholder="e.g., Alice, Bob, Creator42">
                        </div>
                        <div class="sovereign-field">
                            <label for="sovereign-description">What does this melody represent?</label>
                            <input type="text" id="sovereign-description" placeholder="e.g., My core truth, My essence, My song">
                        </div>
                    </div>

                    <label>Compose Your Melody (4-8 notes recommended):</label>
                    <div class="compact-piano" id="compact-piano-grid"></div>
                    
                    <div class="melodybar" id="sovereign-melody-bar"></div>

                    <div class="button-group">
                        <button onclick="clearSovereignMelody()">Clear Melody</button>
                        <button onclick="playSovereignMelody()">Play Back</button>
                        <button onclick="generateSovereignHash()" class="success">Generate & Save</button>
                    </div>

                    <div id="sovereign-result" style="display: none; margin-top: 2rem;">
                        <h4 style="color: var(--success);">Your Sovereign Melody Created!</h4>
                        <div class="melody-hash-display" id="generated-sovereign-hash"></div>
                        <div class="button-group">
                            <button onclick="copyHash('generated-sovereign-hash')">Copy Hash</button>
                            <button onclick="saveSovereignMelody()" class="success">Save to System</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rest of your existing tabs (Query Editor, Preview, etc.) - truncated for space -->
            <!-- Query Editor Tab -->
            <div id="query" class="content-pane">
                <label for="query-input">Query (exact):</label>
                <input type="text" id="query-input" placeholder="e.g. what is cybrjustice?">
                
                <div class="button-group">
                    <button id="load-btn">Load Query</button>
                    <button id="preview-btn" class="accent">Preview</button>
                    <button id="copy-btn">Copy Output</button>
                </div>
                
                <div id="load-msg" class="status-message"></div>
                
                <label for="answer-input">Answer (Markdown supported):</label>
                <textarea id="answer-input"></textarea>
                <div id="char-count" class="content-length">Character count: 0</div>
                
                <div class="button-group">
                    <button id="save-btn" class="success">Save Truth</button>
                    <button id="new-btn">New Truth</button>
                </div>
                
                <div id="save-msg" class="status-message"></div>
            </div>

            <!-- Preview Mode Tab -->
            <div id="preview" class="content-pane">
                <div class="button-group">
                    <button id="back-to-edit-btn">‚Üê Back to Editor</button>
                    <button id="copy-preview-btn">Copy Output</button>
                </div>
                
                <div id="preview-output" class="preview-panel">
                    <p style="text-align: center; color: var(--output-text-color); opacity: 0.7;">
                        Preview content will appear here when generated
                    </p>
                </div>
            </div>

            <!-- Remaining tabs would continue here -->
            <!-- For brevity, including basic structure for remaining tabs -->
            <div id="snippets" class="content-pane">
                <h3>HTML Snippet Extractor & Analyzer</h3>
                <textarea id="html-input" placeholder="Paste your complete HTML here..."></textarea>
                <div class="button-group">
                    <button id="preview-snippet-btn">Preview & Analyze</button>
                    <button id="clear-snippet-btn">Clear</button>
                </div>
                <div id="status-snippet-message" class="status-message"></div>
                <!-- Additional snippet functionality would go here -->
            </div>

            <div id="microsite" class="content-pane">
                <h3>Microsite Snippet Generator</h3>
                <!-- Microsite functionality would go here -->
            </div>

            <div id="library" class="content-pane">
                <h3>Query Library</h3>
                <!-- Library functionality would go here -->
            </div>
        </div>
    </div>

    <script>
        // ================================================================================
        // === SECTION 1: ENHANCED SECURITY / MELODY LOCK LOGIC ===
        // ================================================================================

        // Melody storage system (localStorage for demo - replace with real backend)
        const melodyStore = {
            master: "0459c722cb13f0b60b640c4795640bcba0dcfdbc56532fa26ab5ada3a9ed2edf",
            admin: null,
            personal: new Map()
        };

        const naturalNotes = [48, 50, 52, 53, 55, 57, 59, 60, 62, 64, 65, 67, 69, 71, 72];
        const compactNotes = [60, 62, 64, 65, 67, 69, 71, 72]; // C4 to C5 for sovereign creator
        const palette = ["#d4c4a8", "#00ff8c", "#d7ff00", "#ffe600", "#ff9c00", "#ff3700", "#ff00b3", "#7a00ff", "#0039ff", "#00b3ff", "#00ff6a", "#b6ff00"];
        const noteNames = { 48: 'C3', 50: 'D3', 52: 'E3', 53: 'F3', 55: 'G3', 57: 'A3', 59: 'B3', 60: 'C4', 62: 'D4', 64: 'E4', 65: 'F4', 67: 'G4', 69: 'A4', 71: 'B4', 72: 'C5' };
        
        let melody = [];
        let sovereignMelody = [];
        let synth = null;

        function midiToNoteName(midi) { return noteNames[midi] || '?'; }

        async function initializeAudio() {
            try {
                if (Tone.context.state !== 'running') await Tone.start();
                if (!synth) {
                    synth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: "triangle" },
                        envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
                    }).toDestination();
                }
            } catch (e) {
                console.warn("Tone.js initialization failed:", e);
            }
        }

        async function playPianoNote(note) {
            await initializeAudio();
            const name = midiToNoteName(note);
            if (synth) {
                synth.triggerAttackRelease(name, "16n");
            }
        }

        async function hashMelody(mel) {
            const bytes = new Uint8Array(mel);
            const hashBuf = await crypto.subtle.digest('SHA-256', bytes);
            return Array.from(new Uint8Array(hashBuf)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function patternToMelody(str) { return str.split('-').map(s => parseInt(s, 36)).filter(x => !isNaN(x)); }

        function updateMelodyBar() {
            const bar = document.getElementById('melodyBar');
            bar.innerHTML = '';
            melody.forEach(n => {
                const span = document.createElement('span');
                span.className = 'melodynote';
                span.textContent = midiToNoteName(n);
                bar.appendChild(span);
            });
        }

        function updateSovereignMelodyBar() {
            const bar = document.getElementById('sovereign-melody-bar');
            bar.innerHTML = '';
            sovereignMelody.forEach(n => {
                const span = document.createElement('span');
                span.className = 'melodynote';
                span.textContent = midiToNoteName(n);
                bar.appendChild(span);
            });
        }

        async function playMelody() {
            if (!melody.length) return;
            const bar = document.getElementById('melodyBar');
            const spans = bar.querySelectorAll('.melodynote');
            const duration = 0.25;
            await initializeAudio();
            if (!synth) return;

            let time = Tone.now();
            melody.forEach((note, i) => {
                const name = midiToNoteName(note);
                synth.triggerAttackRelease(name, duration * 0.95, time);
                Tone.Draw.schedule(() => {
                    spans.forEach(s => s.classList.remove('playing'));
                    if (spans[i]) spans[i].classList.add('playing');
                }, time);
                time += duration;
            });
            Tone.Draw.schedule(() => {
                spans.forEach(s => s.classList.remove('playing'));
            }, time);
        }

        async function playSovereignMelody() {
            if (!sovereignMelody.length) return;
            const bar = document.getElementById('sovereign-melody-bar');
            const spans = bar.querySelectorAll('.melodynote');
            const duration = 0.3;
            await initializeAudio();
            if (!synth) return;

            let time = Tone.now();
            sovereignMelody.forEach((note, i) => {
                const name = midiToNoteName(note);
                synth.triggerAttackRelease(name, duration * 0.95, time);
                Tone.Draw.schedule(() => {
                    spans.forEach(s => s.classList.remove('playing'));
                    if (spans[i]) spans[i].classList.add('playing');
                }, time);
                time += duration;
            });
            Tone.Draw.schedule(() => {
                spans.forEach(s => s.classList.remove('playing'));
            }, time);
        }

        // Enhanced Piano Grid Rendering
        function renderGrid() {
            const grid = document.getElementById('piano-grid');
            if (!grid) return;
            grid.innerHTML = '';
            naturalNotes.forEach(n => {
                const btn = document.createElement('button');
                btn.className = 'note-btn';
                btn.dataset.note = n;
                btn.innerHTML = `<span>${midiToNoteName(n)}</span>`;
                btn.style.background = palette[n % 12];
                btn.onclick = async () => {
                    await playPianoNote(n);
                    if (melody.length < 32) {
                        melody.push(n);
                        updateMelodyBar();
                    }
                    btn.classList.add('active');
                    setTimeout(() => btn.classList.remove('active'), 180);
                };
                grid.appendChild(btn);
            });
        }

        function renderCompactGrid() {
            const grid = document.getElementById('compact-piano-grid');
            if (!grid) return;
            grid.innerHTML = '';
            compactNotes.forEach(n => {
                const btn = document.createElement('button');
                btn.className = 'compact-note';
                btn.dataset.note = n;
                btn.textContent = midiToNoteName(n);
                btn.style.background = `linear-gradient(145deg, ${palette[n % 12]}, ${palette[(n + 1) % 12]})`;
                btn.onclick = async () => {
                    await playPianoNote(n);
                    if (sovereignMelody.length < 8) {
                        sovereignMelody.push(n);
                        updateSovereignMelodyBar();
                    }
                    btn.classList.add('active');
                    setTimeout(() => btn.classList.remove('active'), 200);
                };
                grid.appendChild(btn);
            });
        }

        // ================================================================================
        // === SECTION 2: MELODY MANAGEMENT SYSTEM ===
        // ================================================================================

        // Copy hash to clipboard
        function copyHash(elementId) {
            const hash = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(hash).then(() => {
                showMelodyStatus('Hash copied to clipboard!', 'success');
            }).catch(err => {
                showMelodyStatus('Copy failed: ' + err.message, 'error');
            });
        }

        function showMelodyStatus(message, type = 'success') {
            const el = document.getElementById('melody-mgmt-status');
            el.textContent = message;
            el.classList.add('show');
            el.style.borderLeftColor = type === 'success' ? 'var(--success)' : 'var(--warning)';
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        // Play melody from stored hash (demo function)
        async function playMelodyFromHash(level) {
            // In a real implementation, you'd decode the hash back to melody
            showMelodyStatus(`Playing ${level} melody...`, 'success');
            // For demo, play the current melody
            await playMelody();
        }

        // Rotate melody (generate new one)
        async function rotateMelody(level) {
            if (level === 'master') {
                showMelodyStatus('Cannot rotate master melody - system locked', 'error');
                return;
            }
            
            // Generate a random melody
            const newMelody = [];
            const melodyLength = level === 'admin' ? 16 : Math.floor(Math.random() * 5) + 4; // 4-8 for personal
            for (let i = 0; i < melodyLength; i++) {
                newMelody.push(compactNotes[Math.floor(Math.random() * compactNotes.length)]);
            }
            
            const newHash = await hashMelody(newMelody);
            melodyStore[level] = newHash;
            
            if (level === 'admin') {
                document.getElementById('admin-hash').textContent = newHash;
            } else {
                document.getElementById('personal-hash').textContent = 'Individual hashes per user';
            }
            
            showMelodyStatus(`${level} melody rotated successfully!`, 'success');
        }

        // Show sovereign creator tab
        function showSovereignCreator() {
            switchTab('sovereign');
            sovereignMelody = [];
            updateSovereignMelodyBar();
        }

        // Clear sovereign melody
        function clearSovereignMelody() {
            sovereignMelody = [];
            updateSovereignMelodyBar();
        }

        // Generate sovereign hash
        async function generateSovereignHash() {
            const name = document.getElementById('sovereign-name').value.trim();
            const description = document.getElementById('sovereign-description').value.trim();
            
            if (!name) {
                showMelodyStatus('Please enter your name/identifier', 'error');
                return;
            }
            
            if (sovereignMelody.length < 4) {
                showMelodyStatus('Please compose at least 4 notes for your melody', 'error');
                return;
            }
            
            if (sovereignMelody.length > 8) {
                showMelodyStatus('Please limit your melody to 8 notes maximum', 'error');
                return;
            }
            
            const hash = await hashMelody(sovereignMelody);
            
            // Store locally for demo
            melodyStore.personal.set(name, {
                hash: hash,
                melody: [...sovereignMelody],
                description: description,
                created: new Date().toISOString()
            });
            
            document.getElementById('generated-sovereign-hash').textContent = hash;
            document.getElementById('sovereign-result').style.display = 'block';
            
            showMelodyStatus('Sovereign melody generated! Save it to complete.', 'success');
        }

        // Save sovereign melody
        function saveSovereignMelody() {
            const name = document.getElementById('sovereign-name').value.trim();
            const data = melodyStore.personal.get(name);
            
            if (data) {
                // In real implementation, this would save to backend
                localStorage.setItem(`sovereign_${name}`, JSON.stringify(data));
                showMelodyStatus(`Sovereign melody for "${name}" saved!`, 'success');
                document.getElementById('sovereign-result').style.display = 'none';
            }
        }

        // ================================================================================
        // === SECTION 3: ENHANCED API SYSTEM ===
        // ================================================================================

        const API_BASE = "https://truthengine.ai-n.workers.dev";

        // Enhanced API Health Monitor
        async function checkAPIHealth() {
            const statusEl = document.getElementById('api-status');
            const indicator = document.getElementById('api-status-indicator');
            const text = document.getElementById('api-status-text');
            
            try {
                // Try multiple endpoints to determine API status
                const endpoints = [
                    `${API_BASE}/api/health`,
                    `${API_BASE}/api/ai?q=test`,
                    `${API_BASE}/api/ai/truth`
                ];
                
                let apiOnline = false;
                for (const endpoint of endpoints) {
                    try {
                        const resp = await fetch(endpoint, { 
                            method: 'HEAD',
                            headers: { 'Accept': 'application/json' },
                            timeout: 5000
                        });
                        if (resp.ok || resp.status === 404) { // 404 is OK for some endpoints
                            apiOnline = true;
                            break;
                        }
                    } catch (e) {
                        continue; // Try next endpoint
                    }
                }
                
                if (apiOnline) {
                    statusEl.className = 'online';
                    text.textContent = 'API Online';
                } else {
                    statusEl.className = 'offline';
                    text.textContent = 'API Offline';
                }
            } catch (error) {
                statusEl.className = 'offline';
                text.textContent = 'API Offline';
            }
        }

        // Enhanced API call with multiple endpoint support
        async function enhancedAPICall(endpoint, options = {}) {
            const endpoints = [
                endpoint,
                endpoint.replace('/api/ai', '/api/truth'),
                endpoint.replace('/api/ai', '/api'),
                endpoint + '?format=json'
            ];
            
            for (const ep of endpoints) {
                try {
                    const response = await fetch(ep, {
                        ...options,
                        timeout: 10000
                    });
                    
                    if (response.ok) {
                        return response;
                    }
                } catch (error) {
                    continue; // Try next endpoint
                }
            }
            
            throw new Error('All API endpoints failed');
        }

        // ================================================================================
        // === SECTION 4: EXISTING FUNCTIONALITY ENHANCED ===
        // ================================================================================

        // Enhanced load function
        async function loadTruth(query) {
            try {
                // Try multiple API patterns
                const endpoints = [
                    `${API_BASE}/api/ai?q=${encodeURIComponent(query)}`,
                    `${API_BASE}/api/ai/truth`,
                    `${API_BASE}/api/truth?q=${encodeURIComponent(query)}`,
                    `${API_BASE}/api/truth`
                ];
                
                for (const endpoint of endpoints) {
                    try {
                        let options = { headers: { "Accept": "application/json" } };
                        let response;
                        
                        if (endpoint.includes('?')) {
                            // GET request
                            options.method = 'GET';
                            response = await fetch(endpoint, options);
                        } else {
                            // POST request
                            options.method = 'POST';
                            options.headers['Content-Type'] = 'application/json';
                            options.body = JSON.stringify({ query });
                            response = await fetch(endpoint, options);
                        }
                        
                        if (response.ok) {
                            const data = await response.json();
                            return data;
                        }
                    } catch (error) {
                        continue; // Try next endpoint
                    }
                }
                
                throw new Error('No working API endpoint found');
            } catch (error) {
                throw error;
            }
        }

        // Enhanced save function
        async function saveTruth(query, answer, editor, citations = []) {
            try {
                const data = { query, answer, editor, citations };
                const endpoints = [
                    { url: `${API_BASE}/api/ai/truth`, options: { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) } },
                    { url: `${API_BASE}/api/ai/edit-truth`, options: { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ truthId: "truth:" + query.toLowerCase().replace(/[^\w\s]/g, '').replace(/\s+/g, '-'), newText: answer, editor, citations }) } },
                    { url: `${API_BASE}/api/truth`, options: { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) } }
                ];
                
                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(endpoint.url, endpoint.options);
                        if (response.ok) {
                            return response;
                        }
                    } catch (error) {
                        continue; // Try next endpoint
                    }
                }
                
                throw new Error('All save endpoints failed');
            } catch (error) {
                throw error;
            }
        }

        // ================================================================================
        // === SECTION 5: TAB SYSTEM AND UI HANDLERS ===
        // ================================================================================

        function switchTab(tabId) {
            document.querySelectorAll('.content-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            
            document.querySelectorAll('#main-tabs a').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelector(`#main-tabs a[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        // Status function
        function showStatus(el, message, type = 'success') {
            el.textContent = message;
            el.classList.add('show');
            el.classList.remove('success', 'warning');
            if (type === 'success') {
                el.classList.add('success');
                el.style.borderLeftColor = 'var(--success)';
            } else if (type === 'error') {
                el.classList.add('warning');
                el.style.borderLeftColor = 'var(--warning)';
            } else {
                el.style.borderLeftColor = 'var(--button-bg)';
            }
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        // ================================================================================
        // === SECTION 6: EVENT WIRING AND INITIALIZATION ===
        // ================================================================================

        document.addEventListener('DOMContentLoaded', function() {
            // Render piano grids
            renderGrid();
            renderCompactGrid();
            
            // Initial API health check
            checkAPIHealth();
            setInterval(checkAPIHealth, 30000); // Check every 30 seconds
            
            // Melody lock handlers
            document.getElementById('clearMelody').onclick = () => { 
                melody = []; 
                updateMelodyBar();
                document.getElementById('melody-status').textContent = '';
            };

            document.getElementById('playMelody').onclick = playMelody;
            
            document.getElementById('importMelodyBtn').onclick = () => {
                const pat = document.getElementById('importMelodyInput').value.trim();
                if (!pat) return;
                melody = patternToMelody(pat);
                updateMelodyBar();
                document.getElementById('melody-status').textContent = 'Melody pattern imported. Click Unlock Admin.';
            };
            
            document.getElementById('unlockAdmin').onclick = async () => {
                const status = document.getElementById('melody-status');
                if (!melody.length) {
                    status.textContent = 'Please tap or import a melody!';
                    return;
                }
                
                status.textContent = "Checking hash...";
                const hash = await hashMelody(melody);

                if (hash === melodyStore.master) {
                    status.innerHTML = `<span style="color: var(--success)">ACCESS GRANTED.</span>`;
                    document.getElementById('melody-lock').style.display = 'none';
                    document.getElementById('admin-interface').style.display = 'block';
                    document.getElementById('main-tabs').style.display = 'flex';
                    switchTab('query');
                    document.getElementById('current-hash-display').textContent = "Access Granted.";
                    document.getElementById('current-hash-display').style.color = 'var(--success)';
                } else {
                    status.innerHTML = `<span style="color: var(--warning)">ACCESS DENIED. Incorrect melody.</span>`;
                    document.getElementById('current-hash-display').textContent = "Locked: Enter Melody";
                    document.getElementById('current-hash-display').style.color = 'var(--accent)';
                }
            };

            // Tab switching
            document.querySelectorAll('#main-tabs a').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            // Basic query editor handlers
            document.getElementById('load-btn').addEventListener('click', async () => {
                const queryInput = document.getElementById('query-input');
                const answerInput = document.getElementById('answer-input');
                const loadMsg = document.getElementById('load-msg');
                
                loadMsg.textContent = '';
                const query = queryInput.value.trim();
                if (!query) {
                    showStatus(loadMsg, "Enter a query to load.", 'error');
                    return;
                }
                
                showStatus(loadMsg, "Loading...");
                answerInput.value = '';

                try {
                    const data = await loadTruth(query);
                    if (data.answer) {
                        answerInput.value = data.answer;
                        showStatus(loadMsg, "Loaded successfully!");
                    } else {
                        showStatus(loadMsg, "No answer found for this query.", 'warning');
                    }
                } catch (error) {
                    console.error("Load Error:", error);
                    showStatus(loadMsg, `Error: ${error.message}`, 'error');
                }
            });

            document.getElementById('save-btn').addEventListener('click', async () => {
                const queryInput = document.getElementById('query-input');
                const answerInput = document.getElementById('answer-input');
                const editorInput = document.getElementById('editor-input');
                const saveMsg = document.getElementById('save-msg');
                
                saveMsg.textContent = '';
                const query = queryInput.value.trim();
                const answer = answerInput.value;
                const editor = editorInput.value.trim() || "admin";
                
                if (!query || !answer) {
                    showStatus(saveMsg, "Query and answer required.", 'error');
                    return;
                }

                try {
                    await saveTruth(query, answer, editor);
                    showStatus(saveMsg, "Saved successfully!");
                } catch (error) {
                    console.error("Save Error:", error);
                    showStatus(saveMsg, `Error: ${error.message}`, 'error');
                }
            });

            document.getElementById('preview-btn').addEventListener('click', () => {
                switchTab('preview');
            });

            document.getElementById('back-to-edit-btn').addEventListener('click', () => {
                switchTab('query');
            });

            // Character count
            document.getElementById('answer-input').addEventListener('input', (e) => {
                const count = e.target.value.length;
                document.getElementById('char-count').textContent = `Character count: ${count}`;
            });
        });

    </script>
</body>
</html>