<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Truth Engine Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/lib/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/github-dark.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Merriweather:wght@300;700&family=Cutive+Mono&display=swap" rel="stylesheet">
    <!-- Tone.js is required for audio playback on the piano grid -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* Keeping the sophisticated, dark, gold/green theme */
        :root {
            /* Theme 1: Original Dark/Gold */
            --bg-color: #1e1e1e;
            --text-color: #f0f0f0;
            --border-color: #d4c4a8; /* Gold/Tan */
            --modal-bg: #2a2a2a;
            --input-bg: #1a1a1a;
            --button-bg: #d4c4a8;
            --accent: #d4c4a8;
            --success: #00ff8c; /* Neon Green for success */
            --highlight: #d4c4a8;
            --warning: #ffab00;
            --glow: rgba(212, 196, 168, 0.6);
            --melody-note: #d4c4a8;
            --melody-note-active: #00ff8c;

            /* --- OUTPUT THEME VARIABLES (from ad2.html merged) --- */
            /* Default: Silvery */
            --output-bg-color: #f8f8ff; 
            --output-text-color: #1a1a1a;
            --output-secondary-text: #6c757d;
            --output-accent-color: #1a2a3a;
            
            /* Core for blocks */
            --truth-accent-light: #0cf;
            --truth-positive: #00ff8c;
            --truth-warning: #ff5050;
            --block-text-normal: #f0f0f0;

            /* Blocks */
            --block-source-bg: rgba(26, 42, 58, 0.5);
            --block-memo-bg: rgba(0, 71, 171, 0.2);
            --block-blueprint-bg: rgba(0, 255, 136, 0.1);
            --block-logic-bg: #111b2c;
            --block-spy-ink-bg: #000000;
            
        }
        
        /* --- OUTPUT MODE OVERRIDES (SILVERY, DARK, NEO) --- */
        /* Dark Mode */
        [data-output-mode="dark"] {
            --output-bg-color: #1a1a1a;
            --output-text-color: #f0f0f0;
            --output-secondary-text: #9fa8da;
            --output-accent-color: #c7a17a;
            --block-text-normal: #e5f7ff;
        }
        /* Neo (Metric Spring / High Contrast) Mode */
        [data-output-mode="neo"] {
            --output-bg-color: #000000;
            --output-text-color: #00FF00;
            --output-secondary-text: #00AA00;
            --output-accent-color: #00FF00;
            --block-text-normal: #00FF00;
        }

        /* Base styles */
        * { box-sizing: border-box; transition: all .3s ease; }
        
        body {
            background: var(--bg-color);
            color: var(--text-color);
            font-family: 'Merriweather', serif;
            font-size: 1rem;
            margin: 0;
            padding: 2rem 1rem;
            min-height: 100vh;
            box-sizing: border-box;
            line-height: 1.6;
            text-align: center;
            background-image: url('https://www.transparenttextures.com/patterns/dark-matter.png');
        }
        
        .admin-container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--modal-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 5px 15px var(--glow);
        }
        
        h1 {
            color: var(--text-color);
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
            text-align: center;
            letter-spacing: 0.1em;
            text-shadow: 0 0 10px var(--glow);
        }
        
        /* === LOCK SCREEN STYLES === */
        #melody-lock {
            padding: 2rem 1rem;
            border: 2px solid var(--accent);
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .melody-instructions{
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 1.08em;
            border-radius: 7px;
            padding: 10px 14px;
            margin-bottom: 16px;
            margin-top: 10px;
            border-left: 4px solid var(--accent);
            text-align: left;
            max-width: 420px;
            margin-left: auto;
            margin-right: auto
        }
        
        #piano-grid{
            display:grid;
            grid-template-columns:repeat(4,1fr);
            gap:10px;
            margin:1rem 0;
            padding:1rem;
            background:var(--input-bg);
            border-radius:8px;
            border:1px solid var(--accent)
        }
        
        .note-btn{
            height:60px;
            border:2px solid var(--accent);
            border-radius:8px;
            font-size:0.9rem;
            font-weight:bold;
            cursor:pointer;
            box-shadow:0 2px 8px var(--glow);
            color:#000;
            transition:all .2s ease;
            background:linear-gradient(145deg,#f8f8f8 0%,#e8e8e8 100%)
        }
        
        .note-btn:hover{
            transform:scale(1.02);
            box-shadow:0 0 10px var(--glow)
        }
        
        .note-btn.active{
            background:var(--success);
            color:#1e1e1e;
            transform:scale(0.98);
            box-shadow:0 0 15px var(--success)
        }

        .melodybar{
            margin:0.5em 0;
            display:flex;
            flex-wrap:wrap;
            gap:5px;
            justify-content:center
        }

        .melodynote{
            display:inline-block;
            background:var(--melody-note);
            color:#1e1e1e;
            font-weight:bold;
            font-size:0.85rem;
            padding:4px 10px;
            border-radius:18px;
            margin:2px;
            box-shadow:0 1px 3px var(--glow);
            transition:all .15s;
            animation:pulse 0.3s ease-out
        }

        .melodynote.playing{
            background:var(--melody-note-active);
            box-shadow:0 0 10px var(--melody-note-active)
        }

        .import-group{
            margin:0.8em 0 0.5em;
            display:flex;
            justify-content:center;
            gap:10px;
            flex-wrap:wrap
        }
        
        #melody-status{
            font-weight:bold;
            margin-top:10px;
            min-height:22px;
            color:var(--warning);
            letter-spacing:0.02em;
            font-family: 'Cutive Mono', monospace;
        }

        /* === ADMIN CONTENT STYLES === */
        /* Tab System */
        nav.tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 2rem;
        }
        
        nav.tabs a {
            padding: 0.8rem 1.2rem;
            text-decoration: none;
            color: var(--text-color);
            font-family: 'Cutive Mono', monospace;
            font-size: 0.9rem;
            border-right: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        nav.tabs a:hover,
        nav.tabs a:focus {
            background-color: rgba(212, 196, 168, 0.1);
            box-shadow: 0 0 5px var(--glow);
        }
        
        nav.tabs a.active {
            background-color: var(--border-color);
            color: #1e1e1e;
        }
        
        .content-pane {
            display: none;
            padding: 1.5rem 0;
            animation: fadeIn 0.5s ease;
        }
        
        .content-pane.active {
            display: block;
        }
        
        /* Form Elements */
        label {
            display: block;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--border-color);
            text-align: left;
        }
        
        input[type="text"], textarea, select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-color);
            font-family: inherit;
            font-size: 0.9rem;
            box-sizing: border-box;
            margin-bottom: 0.5rem;
            outline: none;
            transition: border 0.3s ease;
            text-align: left;
        }
        
        input[type="text"]:focus, textarea:focus, select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 5px var(--glow);
        }
        
        textarea {
            min-height: 200px;
            font-family: 'Cutive Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        /* Buttons */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        button {
            background: var(--button-bg);
            color: #1e1e1e;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 0.9rem;
            font-family: 'Cutive Mono', monospace;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 700;
        }

        button.accent {
            background: var(--accent);
        }
        
        button.success {
            background: var(--success);
            color: #1e1e1e;
        }
        
        /* Status Messages */
        .status-message {
            margin: 1rem 0;
            padding: 0.8rem;
            background: rgba(212, 196, 168, 0.1);
            border-radius: 4px;
            border-left: 3px solid var(--button-bg);
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            text-align: left;
        }
        
        .status-message.show {
            opacity: 1;
        }
        
        /* Preview Panels */
        .preview-panel {
            width: 100%;
            min-height: 100px;
            padding: 18px;
            margin-top: 12px;
            background: var(--output-bg-color); /* Themed background */
            border: 1.5px solid var(--output-accent-color); /* Themed border */
            border-radius: 9px;
            color: var(--output-text-color); /* Themed text */
            font-size: 1.09em;
            overflow-y: auto;
            box-shadow: 0 2px 13px rgba(0,0,0,.2);
            transition: background .15s;
            text-align: left;
        }
        
        .content-length {
            color: var(--text-color);
            font-size: 0.8rem;
            margin-top: 0.5rem;
            text-align: right;
            opacity: 0.7;
        }
        
        .content-length.warning {
            color: var(--warning);
        }
        
        /* Citations */
        .citations-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
            margin: 1rem 0;
        }
        
        /* === CONTENT CREATION STYLES === */
        
        .creation-helpers-section {
            background: var(--input-bg);
            padding: 15px;
            border-radius: 9px;
            margin-bottom: 15px;
            border-left: 4px solid var(--success);
        }
        .creation-helpers-section h4 {
            color: var(--success);
            margin: 0 0 10px;
            font-weight: 600;
        }
        .mode-select-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 12px;
            justify-content: flex-start;
        }
        .mode-select-row label {
            margin-top: 0;
            font-weight: 500;
            font-size: 1em;
            color: var(--text-color);
        }
        .mode-select-row select {
            width: auto;
            min-height: 38px;
            flex-grow: 1;
        }

        .creation-button-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        .creation-button-row button {
            flex: unset; 
            min-width: 0; 
            padding: 7px 12px; 
            font-size: 0.9em; 
            background: var(--modal-bg); 
            color: var(--success);
            border: 1px solid var(--accent);
            transition: all 0.1s;
        }
        .creation-button-row button:hover {
            background: var(--success);
            color: var(--input-bg);
        }
        .module-stack-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        .module-stack-row select {
            flex-grow: 1;
            margin-bottom: 0;
            min-height: 40px;
        }
        .module-stack-row button {
            margin-top: 0;
            flex: unset;
            padding: 10px 18px;
            background: var(--success);
            color: var(--input-bg);
            font-weight: 600;
        }
        .module-stack-row button:hover {
            background: #00c46e;
        }
        /* Custom Block Styles (for preview rendering) */
        .preview .block-source-bg { background-color: rgba(26, 42, 58, 0.5); padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        .preview .block-memo-bg { background-color: rgba(0, 71, 171, 0.2); border-left: 4px solid var(--truth-accent-light); padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        .preview .block-blueprint-bg { background-color: rgba(0, 255, 136, 0.1); border: 2px dashed var(--truth-positive); padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        .preview .block-logic-bg { background-color: #111b2c; font-family: 'Courier New', monospace; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        .preview .block-spy-ink-bg { background-color: var(--output-bg-color); border: 1px dashed red; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        .preview .block-spy-ink-bg p { color: var(--output-bg-color) !important; transition: none; } /* Hide text by setting color to background color */


        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* === SNIPPET EXTRACTOR STYLES === */
        .tab-buttons {
            display: flex;
            margin-bottom: 10px;
            margin-top: 1rem;
        }
        
        .tab-buttons button {
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 5px 5px 0 0;
            padding: 10px;
            cursor: pointer;
            margin-right: 2px;
            font-weight: 400;
        }
        
        .tab-buttons button.active {
            background: var(--border-color);
            color: #1e1e1e;
        }

        .snippet-container {
            min-height: 500px;
            border: 2px solid var(--border-color);
            background: var(--input-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: var(--text-color);
            text-align: left;
        }
        
        .snippet-container iframe {
            width: 100%;
            height: 430px; 
            border: none;
            background: white;
            border-radius: 4px;
        }
        
        .snippet-container textarea {
            min-height: 150px;
            background: #0a0a0a;
            color: var(--success);
            font-family: 'Cutive Mono', monospace;
        }
        
        .analysis-section {
            background: rgba(212, 196, 168, 0.05);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid var(--border-color);
        }
        
        .analysis-item {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .analysis-item strong {
            color: var(--border-color);
        }
        
        #snippet-output {
            background: var(--input-bg);
            color: var(--text-color);
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Cutive Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.3;
            border: 1px solid var(--border-color);
            margin-top: 15px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .admin-container {
                padding: 1rem;
            }
            
            nav.tabs a {
                padding: 0.6rem;
                font-size: 0.8rem;
            }
            
            .button-group {
                flex-direction: column;
            }
            .mode-select-row {
                flex-direction: column;
                align-items: stretch;
            }
            .module-stack-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body data-output-mode="silvery">
    <div class="admin-container">
        <h1>eitl truth editor</h1>
        
        <!-- === MELODY LOCK SCREEN === -->
        <div id="melody-lock">
            <h2 style="color:var(--accent); font-family: 'Cinzel', serif; margin-top:0;">ACCESS PROTOCOL</h2>
            
            <div class="melody-instructions">
                <b>Unlock Protocol:</b> Play the melody that matches the hardcoded hash. Generate melody/pattern in <a href="aincipher.html" style="color:var(--success)">ai-n cipher</a>.<br>
                <div style="font-size:0.95em;margin-top:7px;opacity:0.87;">**Status:** <span id="current-hash-display" style="font-family:'Cutive Mono', monospace;">Waiting for input...</span></div>
            </div>
            
            <div id="piano-grid"></div>
            
            <div class="melody-controls button-group">
                <button id="clearMelody">Clear Melody</button>
                <button id="playMelody">Play Melody</button>
                <button id="unlockAdmin" class="success">Unlock Admin</button>
            </div>
            
            <div class="melodybar" id="melodyBar"></div>
            
            <div class="import-group">
                <input type="text" id="importMelodyInput" placeholder="Pattern e.g. 1o-1q-1s">
                <button id="importMelodyBtn">Import Pattern</button>
            </div>
            
            <div id="melody-status"></div>
        </div>
        
        <!-- === MAIN ADMIN INTERFACE (Hidden until unlocked) === -->
        <div id="admin-interface" style="display:none;">
            <nav class="tabs" id="main-tabs">
                <a href="#" class="active" data-tab="query">Query Editor</a>
                <a href="#" data-tab="preview">Preview Mode</a>
                <a href="#" data-tab="snippets">HTML View & Extractor</a> 
                <a href="#" data-tab="microsite">Microsite Snippets</a>
                <a href="#" data-tab="library">Query Library</a>
            </nav>
            
            <!-- Query Editor Tab -->
            <div id="query" class="content-pane active">
                <label for="query-input">Query (exact):</label>
                <input type="text" id="query-input" placeholder="e.g. what is cybrjustice?">
                
                <div class="button-group">
                    <button id="load-btn">Load Query</button>
                    <button id="preview-btn" class="accent">Preview</button>
                    <button id="copy-btn">Copy Output</button>
                </div>
                
                <div id="load-msg" class="status-message"></div>
                
                <label for="answer-input">Answer (Markdown supported):</label>
                
                <!-- CONTENT CREATION HELPERS -->
                <div class="creation-helpers-section">
                    <h4>Content Creation Helpers</h4>
                    
                    <div class="mode-select-row">
                        <label for="output-mode-select">Preview Theme:</label>
                        <select id="output-mode-select" onchange="setMode(this.value)">
                            <option value="silvery">Silvery (Default)</option>
                            <option value="dark">Dark</option>
                            <option value="neo">Neo (High Contrast)</option>
                        </select>
                    </div>

                    <div class="creation-button-row">
                        <button onclick="insertMarkdown('**text**', '**', '**')">Bold</button>
                        <button onclick="insertMarkdown('`code`', '`', '`')">Code</button>
                        <button onclick="insertMarkdown('[link](url)', '[', '](url)')">Link</button>
                        <button onclick="insertMarkdown('## Heading', '## ', '')">H2</button>
                        <button onclick="insertMarkdown('- item', '- ', '')">List</button>
                        <button onclick="insertIframe()">iFrame Template</button>
                        <button onclick="insertCitationBlock()">Citation Block</button>
                        <button onclick="removeExtraWhitespace()" style="background: var(--modal-bg); color: var(--text-color);">Cleanup Whitespace</button>
                    </div>
                    
                    <div class="module-stack-row">
                        <select id="style-select">
                            <option value="source-block">Source Material Block</option>
                            <option value="memo-block">General Memo Block</option>
                            <option value="blueprint-block">Blueprint Block</option>
                            <option value="logic-block">Logic/Code Block</option>
                            <option value="spy-ink-block">Spy Ink Block (Hidden)</option>
                        </select>
                        <button onclick="addBlock()">Insert Block</button>
                    </div>
                    
                </div>
                <!-- END CONTENT CREATION HELPERS -->

                <textarea id="answer-input"></textarea>
                <div id="char-count" class="content-length">Character count: 0</div>
                
                <label>Citations (up to 2):</label>
                <div class="citations-container">
                    <input type="text" placeholder="Title 1" class="citation-title">
                    <input type="text" placeholder="URL 1" class="citation-url">
                    <input type="text" placeholder="Title 2" class="citation-title">
                    <input type="text" placeholder="URL 2" class="citation-url">
                </div>
                
                <label for="editor-input">Your Name (for audit):</label>
                <input type="text" id="editor-input" placeholder="admin">
                
                <div class="button-group">
                    <button id="save-btn" class="success">Save Truth</button>
                    <button id="new-btn">New Truth</button>
                </div>
                
                <div id="save-msg" class="status-message"></div>
            </div>
            
            <!-- Preview Mode Tab -->
            <div id="preview" class="content-pane">
                <div class="button-group">
                    <button id="back-to-edit-btn">‚Üê Back to Editor</button>
                    <button id="copy-preview-btn">Copy Output</button>
                    <button id="export-preview-btn" class="accent">Export as HTML</button>
                </div>
                
                <div id="preview-output" class="preview-panel">
                    <p style="text-align: center; color: var(--output-text-color); opacity: 0.7;">
                        Preview content will appear here when generated
                    </p>
                </div>
            </div>
            
            <!-- HTML Snippets Tab (Enhanced Extractor) -->
            <div id="snippets" class="content-pane">
                <h3>HTML Snippet Extractor & Analyzer</h3>
                <textarea id="html-input" placeholder="Paste your complete HTML here..."></textarea>
                <div class="button-group">
                    <button id="preview-snippet-btn">Preview & Analyze</button>
                    <button id="clear-snippet-btn">Clear</button>
                </div>
                <div id="status-snippet-message" class="status-message"></div>
                
                <div class="tab-buttons">
                    <button class="active" data-tab="preview-snippet-tab">Preview</button>
                    <button data-tab="analysis-snippet-tab">Analysis</button>
                    <button data-tab="snippets-extract-tab">Extractor</button>
                </div>
                
                <div class="snippet-container" id="preview-snippet-tab">
                    <iframe id="preview-frame-snippet"></iframe>
                </div>
                
                <div class="snippet-container" id="analysis-snippet-tab" style="display:none;">
                    <h3>HTML Structure Analysis</h3>
                    <div id="analysis-results-snippet">
                        <p>Click "Preview & Analyze" to see detailed analysis of your HTML structure.</p>
                    </div>
                </div>
                
                <div class="snippet-container" id="snippets-extract-tab" style="display:none;">
                    <h3>Extract Code Snippets</h3>
                    <div class="snippet-controls button-group" style="justify-content: flex-start; margin-top: 0;">
                        <select id="snippet-type" style="width: auto; flex-grow: 1;">
                            <option value="full">Full Page</option>
                            <option value="head">Head Section</option>
                            <option value="styles">All Styles</option>
                            <option value="scripts">All Scripts</option>
                            <option value="nav">Navigation Elements</option>
                            <option value="header">Header Section</option>
                            <option value="main">Main Content</option>
                            <option value="footer">Footer Section</option>
                            <option value="forms">Form Elements</option>
                            <option value="tables">Table Elements</option>
                            <option value="lists">List Elements</option>
                            <option value="images">Image Elements</option>
                            <option value="links">Link Elements</option>
                        </select>
                        <button id="generate-snippet-btn" class="accent" style="flex-grow: 0;">Generate</button>
                        <button id="copy-snippet-btn" style="flex-grow: 0;">Copy</button>
                    </div>
                    <pre id="snippet-output"><code>// Select a component type and click Generate</code></pre>
                </div>
            </div>
            
            <!-- Microsite Snippets Tab -->
            <div id="microsite" class="content-pane">
                <h3>Microsite Snippet Generator</h3>
                <label for="microsite-type">Snippet Type:</label>
                <select id="microsite-type">
                    <option value="tabs">Tabs</option>
                    <option value="constellation">Constellation</option>
                    <option value="dossier">Dossier</option>
                    <option value="query-trigger">Query Trigger</option>
                </select>
                
                <div id="tabs-options" class="microsite-options">
                    <label for="tab-titles">Tab Titles (comma separated):</label>
                    <input type="text" id="tab-titles" placeholder="summary,context,founding">
                    
                    <label for="tab-contents">Tab Contents (Markdown, separate with '---'):</label>
                    <textarea id="tab-contents" placeholder="First content...\n---\nSecond content...\n---\nThird content..."></textarea>
                </div>
                
                <div id="constellation-options" class="microsite-options" style="display:none;">
                    <label for="constellation-title">Constellation Title:</label>
                    <input type="text" id="constellation-title" placeholder="Core Principles">
                    
                    <label for="constellation-nodes">Nodes (comma separated):</label>
                    <input type="text" id="constellation-nodes" placeholder="justice,equity,transparency">
                </div>
                
                <div id="query-trigger-options" class="microsite-options" style="display:none;">
                    <label for="trigger-query">Trigger Query:</label>
                    <input type="text" id="trigger-query" placeholder="what is cybrjustice?">
                    
                    <label for="trigger-text">Display Text:</label>
                    <input type="text" id="trigger-text" placeholder="Learn about cybrjustice">
                </div>
                
                <div class="button-group">
                    <button id="generate-microsite-btn" class="accent">Generate Snippet</button>
                    <button id="copy-microsite-btn">Copy Snippet</button>
                </div>
                
                <div class="microsite-code">
                    <h4>Microsite Snippet:</h4>
                    <pre id="microsite-code-output"><code>// Your microsite snippet will appear here</code></pre>
                </div>
            </div>
            
            <!-- Query Library Tab -->
            <div id="library" class="content-pane">
                <div class="form-grid">
                    <div>
                        <label for="library-search">Search Truths:</label>
                        <input type="text" id="library-search" placeholder="Search your truth library">
                        
                        <div class="preview-panel" style="height: 400px;">
                            <h3>Saved Truths</h3>
                            <ul id="truth-list">
                                <!-- Populated by JS -->
                            </ul>
                        </div>
                    </div>
                    
                    <div>
                        <label>Truth Details</label>
                        <div class="preview-panel" style="height: 400px;">
                            <h3 id="library-truth-title">Select a truth to view details</h3>
                            <div id="library-truth-content">
                                <p>When you select a truth from the list, its contents will appear here.</p>
                                <p>You can then load it into the editor to make changes.</p>
                            </div>
                            <div class="button-group" style="margin-top: 1rem;">
                                <button id="load-library-btn" disabled>Load into Editor</button>
                                <button id="delete-library-btn" disabled style="background: var(--accent)">Delete Truth</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- End of Admin Interface -->
    </div>

    <script>
        // ================================================================================
        // === SECTION 1: SECURITY / MELODY LOCK LOGIC ===
        // ================================================================================

        // 1. HARDCODED HASH (MUST BE MANUALLY UPDATED)
        const allowedMelodyHash = "e4a25ba5b1c669414746d9efdc533019e14bf8a86c288165de44bdcf791d4cfa"; 
        
        // 2. MELODY AND HASH UTILS
        const naturalNotes = [48,50,52,53,55,57,59,60,62,64,65,67,69,71,72];
        const palette = ["#d4c4a8","#00ff8c","#d7ff00","#ffe600","#ff9c00","#ff3700","#ff00b3","#7a00ff","#0039ff","#00b3ff","#00ff6a","#b6ff00"];
        const noteNames = {48:'C3',50:'D3',52:'E3',53:'F3',55:'G3',57:'A3',59:'B3',60:'C4',62:'D4',64:'E4',65:'F4',67:'G4',69:'A4',71:'B4',72:'C5'};
        let melody = [];
        let synth = null;
        
        function midiToNoteName(midi){ return noteNames[midi] || '?'; }

        async function initializeAudio() {
            try {
                if (Tone.context.state !== 'running') await Tone.start();
                if (!synth) {
                    synth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: "triangle" },
                        envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
                    }).toDestination();
                }
            } catch (e) {
                console.warn("Tone.js initialization failed:", e);
            }
        }
        
        async function playPianoNote(note) {
            await initializeAudio();
            const name = midiToNoteName(note);
            if (synth) {
                synth.triggerAttackRelease(name, "16n");
            }
        }
        
        async function hashMelody(mel){
            const bytes=new Uint8Array(mel);
            const hashBuf=await crypto.subtle.digest('SHA-256',bytes);
            return Array.from(new Uint8Array(hashBuf)).map(b=>b.toString(16).padStart(2,'0')).join('');
        }
        
        function patternToMelody(str){ return str.split('-').map(s=>parseInt(s,36)).filter(x=>!isNaN(x)); }
        
        function updateMelodyBar(){
            const bar=document.getElementById('melodyBar');
            bar.innerHTML='';
            melody.forEach(n=>{
                const span=document.createElement('span');
                span.className='melodynote';
                span.textContent=midiToNoteName(n);
                bar.appendChild(span);
            });
        }
        
        async function playMelody(){
            if(!melody.length)return;
            const bar = document.getElementById('melodyBar');
            const spans = bar.querySelectorAll('.melodynote');
            const duration = 0.25; 
            
            await initializeAudio();
            if (!synth) return;

            let time = Tone.now();
            
            melody.forEach((note, i) => {
                const name = midiToNoteName(note);
                synth.triggerAttackRelease(name, duration * 0.95, time);
                
                Tone.Draw.schedule(() => {
                    spans.forEach(s => s.classList.remove('playing'));
                    if (spans[i]) spans[i].classList.add('playing');
                }, time);
                time += duration;
            });
            
            Tone.Draw.schedule(() => {
                spans.forEach(s => s.classList.remove('playing'));
            }, time);
        }
        
        // 3. PIANO GRID RENDERING
        function renderGrid(){
            const grid = document.getElementById('piano-grid');
            if (!grid) return;
            grid.innerHTML = '';
            
            naturalNotes.forEach(n => {
                const btn = document.createElement('button');
                btn.className = 'note-btn';
                btn.dataset.note = n;
                btn.innerHTML = `<span>${midiToNoteName(n)}</span>`;
                btn.style.background = palette[n % 12];
                
                btn.onclick = async () => {
                    await playPianoNote(n);
                    if (melody.length < 32) {
                        melody.push(n);
                        updateMelodyBar();
                    }
                    btn.classList.add('active');
                    setTimeout(() => btn.classList.remove('active'), 180);
                };
                grid.appendChild(btn);
            });
        }
        
        // 4. LOCK SCREEN HANDLERS
        document.getElementById('clearMelody').onclick = () => { 
            melody = []; 
            updateMelodyBar();
            document.getElementById('melody-status').textContent = '';
        };

        document.getElementById('playMelody').onclick = playMelody;
        
        document.getElementById('importMelodyBtn').onclick = () => {
            const pat = document.getElementById('importMelodyInput').value.trim();
            if (!pat) return;
            melody = patternToMelody(pat);
            updateMelodyBar();
            document.getElementById('melody-status').textContent = 'Melody pattern imported. Click Unlock Admin.';
        };
        
        document.getElementById('unlockAdmin').onclick = async () => {
            const status = document.getElementById('melody-status');
            if (!melody.length){
                status.textContent = 'Please tap or import a melody!';
                return;
            }
            
            status.textContent = "Checking hash...";
            const hash = await hashMelody(melody);

            if(hash === allowedMelodyHash){
                status.innerHTML = `<span style="color:var(--success)">ACCESS GRANTED.</span>`;
                document.getElementById('melody-lock').style.display = 'none';
                document.getElementById('admin-interface').style.display = 'block';
                document.getElementById('main-tabs').style.display = 'flex'; 
                switchTab('query'); 
                document.getElementById('current-hash-display').textContent = "Access Granted.";
                document.getElementById('current-hash-display').style.color = 'var(--success)';
                initializeEditor();
            } else {
                status.innerHTML = `<span style="color:var(--warning)">ACCESS DENIED. Incorrect melody.</span>`;
                document.getElementById('current-hash-display').textContent = "Locked: Enter Melody";
                document.getElementById('current-hash-display').style.color = 'var(--accent)';
            }
        };

        // 5. INITIAL CHECK
        function initialUnlockCheck() {
            const hashDisplay = document.getElementById('current-hash-display');
            if (!allowedMelodyHash || allowedMelodyHash.length !== 64) {
                // Auto-unlock if no hash is set or it's clearly invalid
                document.getElementById('melody-lock').style.display = 'none';
                document.getElementById('admin-interface').style.display = 'block';
                document.getElementById('main-tabs').style.display = 'flex';
                switchTab('query');
                hashDisplay.textContent = "UNLOCKED (TEST MODE)";
                hashDisplay.style.color = 'var(--warning)';
                initializeEditor();
            } else {
                hashDisplay.textContent = "Locked: Enter Melody";
                hashDisplay.style.color = 'var(--accent)';
            }
        }
        
        // ================================================================================
        // === SECTION 2: CORE ADMIN LOGIC & HELPERS ===
        // ================================================================================

        // DOM elements (declared globally for access)
        const queryInput = document.getElementById('query-input');
        const answerInput = document.getElementById('answer-input');
        const editorInput = document.getElementById('editor-input');
        const loadBtn = document.getElementById('load-btn');
        const previewBtn = document.getElementById('preview-btn');
        const copyBtn = document.getElementById('copy-btn');
        const saveBtn = document.getElementById('save-btn');
        const newBtn = document.getElementById('new-btn');
        const loadMsg = document.getElementById('load-msg');
        const saveMsg = document.getElementById('save-msg');
        const charCount = document.getElementById('char-count');
        const backToEditBtn = document.getElementById('back-to-edit-btn');
        const copyPreviewBtn = document.getElementById('copy-preview-btn');
        const previewOutput = document.getElementById('preview-output');
        const citationTitles = document.querySelectorAll('.citation-title');
        const citationUrls = document.querySelectorAll('.citation-url');
        const styleSelect = document.getElementById('style-select');

        // API configuration
        const API_BASE = "https://justice.ai-n.workers.dev";
        
        // Status function
        function showStatus(el, message, type = 'success') {
            el.textContent = message;
            el.classList.add('show');
            el.classList.remove('success', 'warning'); 
            if (type === 'success') {
                 el.classList.add('success');
                 el.style.borderLeftColor = 'var(--success)';
            } else if (type === 'error') {
                 el.classList.add('warning');
                 el.style.borderLeftColor = 'var(--warning)';
            } else {
                 el.style.borderLeftColor = 'var(--button-bg)';
            }
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        // Theme setter
        function setMode(mode) {
            document.body.setAttribute('data-output-mode', mode);
            answerInput.dispatchEvent(new Event('input'));
        }

        // Tab switching
        function switchTab(tabId) {
            document.querySelectorAll('.content-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            
            document.querySelectorAll('#main-tabs a').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelector(`#main-tabs a[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            if (tabId === 'preview') {
                updatePreview();
            }
            if (tabId === 'library') {
                renderTruthLibrary();
            }
        }
        
        // Update Preview
        function updatePreview() {
            const content = answerInput.value || '';
            previewOutput.innerHTML = marked.parse(content);
            
            // FIX: Added defensive check for hljs
            if (typeof hljs !== 'undefined' && hljs.highlightElement) {
                document.querySelectorAll('#preview-output pre code').forEach(block => {
                    hljs.highlightElement(block);
                });
            }
        }

        // Markdown Helpers
        function insertMarkdown(text, before, after) {
            const start = answerInput.selectionStart;
            const end = answerInput.selectionEnd;
            const selected = answerInput.value.substring(start, end);
            const replacement = before + (selected || text) + after;
            
            answerInput.value = answerInput.value.substring(0, start) + replacement + answerInput.value.substring(end);
            answerInput.focus();
            answerInput.selectionStart = start + before.length;
            answerInput.selectionEnd = start + before.length + (selected || text).length;
            
            answerInput.dispatchEvent(new Event('input'));
        }
        
        function insertIframe() {
            const iframeCode = '\n<iframe src="https://example.com" style="border:1px solid var(--accent); width:100%; height:300px;"></iframe>\n';
            answerInput.value += iframeCode;
            answerInput.dispatchEvent(new Event('input'));
            answerInput.focus();
        }

        function insertCitationBlock() {
            let citationsMarkdown = '| Title | URL |\n|-------|-----|\n';
            citationTitles.forEach((title, i) => {
                const url = citationUrls[i].value.trim();
                if (title.value.trim() && url) {
                    citationsMarkdown += `| ${title.value.trim()} | [${url}](${url}) |\n`;
                }
            });
            if (citationsMarkdown === '| Title | URL |\n|-------|-----|\n') {
                showStatus(saveMsg, 'Add citations first in the fields below!', 'error');
                return;
            }
            answerInput.value += `\n\n${citationsMarkdown}`;
            answerInput.dispatchEvent(new Event('input'));
            answerInput.focus();
        }
        
        function removeExtraWhitespace() {
            const content = answerInput.value;
            const cleaned = content.split('\n').map(l => l.trim()).join('\n').replace(/\n\n\n+/g, '\n\n');
            answerInput.value = cleaned;
            answerInput.dispatchEvent(new Event('input'));
            showStatus(saveMsg, 'Whitespace cleaned!', 'success');
        }
        
        function addBlock() {
            const style = styleSelect.value;
            let htmlSnippet = '';
            
            switch(style) {
                case 'source-block':
                    htmlSnippet = '\n<div class="block-source-bg">\n<p style="color: var(--block-text-normal); margin: 0; font-style: italic;">&gt; [Source: The key principle is modularity. Replace with quote.]</p>\n</div>\n';
                    break;
                case 'memo-block':
                    htmlSnippet = '\n<div class="block-memo-bg">\n<p style="color: var(--block-text-normal); margin: 0;">[Memo: Use this space for an important note or summary.]</p>\n</div>\n';
                    break;
                case 'blueprint-block':
                    htmlSnippet = '\n<div class="block-blueprint-bg">\n<h4 style="color: var(--truth-positive); margin-top: 0;">Blueprint:</h4><p style="color: var(--block-text-normal);">[Drafting: Describe a technical or structural concept here.]</p>\n</div>\n';
                    break;
                case 'logic-block':
                    htmlSnippet = '\n<div class="block-logic-bg">\n<h4 style="color: var(--truth-accent-light); margin-top: 0;">Logic:</h4><pre style="color: #afeeee; white-space: pre-wrap; margin: 0;">function calculateTruth() { return true; }</pre>\n</div>\n';
                    break;
                case 'spy-ink-block':
                    htmlSnippet = '\n<div class="block-spy-ink-bg">\n<p class="spy-ink-text" style="color: var(--output-bg-color); margin: 0;">[Hidden: Content that should not be visible on this background.]</p>\n</div>\n';
                    break;
                default: return;
            }

            answerInput.value += htmlSnippet;
            answerInput.dispatchEvent(new Event('input'));
            answerInput.focus();
            showStatus(saveMsg, `${style.replace('-', ' ')} added!`, 'status');
        }

        // ================================================================================
        // === SECTION 3: HTML SNIPPET EXTRACTOR LOGIC (FIXED) ===
        // ================================================================================
        
        const htmlInput = document.getElementById('html-input');
        const previewSnippetBtn = document.getElementById('preview-snippet-btn');
        const clearSnippetBtn = document.getElementById('clear-snippet-btn');
        const statusSnippetMessage = document.getElementById('status-snippet-message');
        const snippetType = document.getElementById('snippet-type');
        const generateSnippetBtn = document.getElementById('generate-snippet-btn');
        const copySnippetBtn = document.getElementById('copy-snippet-btn');
        const snippetOutput = document.getElementById('snippet-output');
        
        let currentHTMLSnippet = '';
        let parsedDocumentSnippet = null;

        function showSnippetStatus(message, type = 'success') {
            const el = statusSnippetMessage;
            el.textContent = message;
            el.classList.add('show');
            el.classList.remove('success', 'warning'); 
            if (type === 'success') {
                 el.classList.add('success');
                 el.style.borderLeftColor = 'var(--success)';
            } else if (type === 'error') {
                 el.classList.add('warning');
                 el.style.borderLeftColor = 'var(--warning)';
            } else {
                 el.style.borderLeftColor = 'var(--button-bg)';
            }
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        function analyzeHTMLSnippet(html) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                parsedDocumentSnippet = doc;
                
                // --- ANALYSIS LOGIC (simplified for brevity, ensures DOM access) ---
                const analysis = {
                    totalElements: doc.querySelectorAll('*').length,
                    headElements: doc.querySelectorAll('head *').length,
                    bodyElements: doc.querySelectorAll('body *').length,
                    links: doc.querySelectorAll('a').length,
                    scripts: doc.querySelectorAll('script').length,
                    styles: doc.querySelectorAll('style, link[rel="stylesheet"]').length,
                    classes: new Set(Array.from(doc.querySelectorAll('[class]')).map(el => el.className.split(' ')).flat().filter(c => c.trim())).size,
                    ids: doc.querySelectorAll('[id]').length
                };

                const resultsContainer = document.getElementById('analysis-results-snippet');
                resultsContainer.innerHTML = `
                    <div class="analysis-section">
                        <h4>Structure Overview</h4>
                        <div class="analysis-item"><span>Total Elements:</span> <strong>${analysis.totalElements}</strong></div>
                        <div class="analysis-item"><span>Elements in Body:</span> <strong>${analysis.bodyElements}</strong></div>
                        <div class="analysis-item"><span>Links (a):</span> <strong>${analysis.links}</strong></div>
                        <div class="analysis-item"><span>Scripts:</span> <strong>${analysis.scripts}</strong></div>
                        <div class="analysis-item"><span>Styles (style/link):</span> <strong>${analysis.styles}</strong></div>
                        <div class="analysis-item"><span>Unique Classes:</span> <strong>${analysis.classes}</strong></div>
                    </div>
                `;

                return analysis;
            } catch (error) {
                document.getElementById('analysis-results-snippet').innerHTML = `<p style="color: var(--warning);">Analysis Error: ${error.message}</p>`;
                return null;
            }
        }

        previewSnippetBtn.addEventListener('click', function() {
            const html = htmlInput.value;
            if (!html.trim()) {
                showSnippetStatus("Please enter HTML content", "error");
                return;
            }
            
            currentHTMLSnippet = html;
            
            const iframe = document.getElementById('preview-frame-snippet');
            const blob = new Blob([html], {type: 'text/html'});
            iframe.src = URL.createObjectURL(blob);
            
            analyzeHTMLSnippet(html);
            showSnippetStatus("HTML previewed and analyzed successfully!");
        });

        clearSnippetBtn.addEventListener('click', function() {
            htmlInput.value = '';
            document.getElementById('preview-frame-snippet').src = '';
            document.getElementById('analysis-results-snippet').innerHTML = '<p>Click "Preview & Analyze" to see detailed analysis of your HTML structure.</p>';
            document.getElementById('snippet-output').innerHTML = '<code>// Select a component type and click Generate</code>';
            currentHTMLSnippet = '';
            parsedDocumentSnippet = null;
            showSnippetStatus("Content cleared");
        });

        generateSnippetBtn.addEventListener('click', function() {
            if (!currentHTMLSnippet || !parsedDocumentSnippet) {
                showSnippetStatus("Please preview and analyze HTML first", "error");
                return;
            }
            
            const type = snippetType.value;
            let snippet = '';
            let elements = [];
            
            try {
                switch(type) {
                    case 'full':
                        snippet = currentHTMLSnippet;
                        break;
                    case 'head':
                        const head = parsedDocumentSnippet.querySelector('head');
                        snippet = head ? head.outerHTML : '<!-- No head section found -->';
                        break;
                    case 'main':
                        // Use document.body to ensure content is pulled, as main might not exist
                        const bodyContent = parsedDocumentSnippet.body.innerHTML; 
                        // Strip script tags from body content for clean main content extraction
                        snippet = bodyContent.replace(/<script\b[^>]*>([\s\S]*?)<\/script>/gim, "<!-- Removed Script -->");
                        break;
                    case 'styles':
                        elements = Array.from(parsedDocumentSnippet.querySelectorAll('style, link[rel="stylesheet"]'));
                        snippet = elements.map(el => el.outerHTML).join('\n\n');
                        break;
                    case 'scripts':
                        elements = Array.from(parsedDocumentSnippet.querySelectorAll('script'));
                        snippet = elements.map(el => el.outerHTML).join('\n\n');
                        break;
                    case 'nav':
                    case 'header':
                    case 'footer':
                    case 'forms':
                    case 'tables':
                    case 'lists':
                    case 'images':
                    case 'links':
                        // Use a generic query selector for robust extraction
                        let selector = {
                            'nav': 'nav, .nav, .navigation',
                            'header': 'header, .header',
                            'footer': 'footer, .footer',
                            'forms': 'form',
                            'tables': 'table',
                            'lists': 'ul, ol, menu',
                            'images': 'img',
                            'links': 'a'
                        }[type];

                        elements = Array.from(parsedDocumentSnippet.querySelectorAll(selector));
                        snippet = elements.map(el => el.outerHTML).join('\n\n');
                        break;
                    default:
                        snippet = `<!-- Selection type ${type} not recognized. -->`;
                }

                // If no elements found, provide a clean message
                if (!snippet.trim() && elements.length === 0) {
                    snippet = `<!-- No ${type.toLowerCase()} elements found in the pasted HTML. -->`;
                }

                // Apply syntax highlighting
                let highlighted = `<code>${snippet}</code>`;
                if (typeof hljs !== 'undefined' && hljs.highlight) {
                    highlighted = hljs.highlight(snippet, {language: 'html'}).value;
                }
                snippetOutput.innerHTML = highlighted;
                
                showSnippetStatus(`${type.charAt(0).toUpperCase() + type.slice(1)} snippet generated successfully!`);
                
            } catch (e) {
                snippetOutput.innerHTML = `<code>ERROR: ${e.message}</code>`;
                showSnippetStatus(`Error generating snippet: ${e.message}`, "error");
            }
        });

        copySnippetBtn.addEventListener('click', function() {
            const snippetElement = snippetOutput;
            if (!snippetElement || !snippetElement.textContent.trim()) {
                showSnippetStatus("No snippet to copy", "error");
                return;
            }
            
            const snippet = snippetElement.textContent;
            const tempInput = document.createElement('textarea');
            tempInput.value = snippet;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);

            showSnippetStatus('Snippet copied to clipboard!');
        });

        // ================================================================================
        // === SECTION 4: MICROSITE SNIPPET LOGIC ===
        // ================================================================================

        const micrositeType = document.getElementById('microsite-type');
        const tabsOptions = document.getElementById('tabs-options');
        const constellationOptions = document.getElementById('constellation-options');
        const queryTriggerOptions = document.getElementById('query-trigger-options');
        const generateMicrositeBtn = document.getElementById('generate-microsite-btn');
        const copyMicrositeBtn = document.getElementById('copy-microsite-btn');
        const micrositeCode = document.getElementById('microsite-code-output');

        micrositeType.addEventListener('change', () => {
            document.querySelectorAll('.microsite-options').forEach(el => {
                el.style.display = 'none';
            });
            
            if (micrositeType.value === 'tabs') {
                tabsOptions.style.display = 'block';
            } else if (micrositeType.value === 'constellation') {
                constellationOptions.style.display = 'block';
            } else if (micrositeType.value === 'query-trigger') {
                queryTriggerOptions.style.display = 'block';
            }
        });
        
        generateMicrositeBtn.addEventListener('click', () => {
            const type = micrositeType.value;
            let snippet = '';
            
            if (type === 'tabs') {
                const titles = document.getElementById('tab-titles').value.split(',').map(t => t.trim()).filter(t => t);
                const contents = document.getElementById('tab-contents').value.split('---').map(c => c.trim()).filter(c => c);

                if (titles.length === 0 || contents.length === 0 || titles.length !== contents.length) {
                    showStatus(saveMsg, "Tabs require matching titles and contents.", 'error');
                    return;
                }
                
                snippet = `<style>
.tabs-snippet-container {
    font-family: 'Merriweather', serif;
    background: var(--output-bg-color);
    color: var(--output-text-color);
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid var(--output-accent-color);
}
nav.tabs-snippet { 
    display: flex; 
    flex-wrap: wrap;
    border-bottom: 2px solid var(--output-accent-color);
    margin-bottom: 1rem;
}
nav.tabs-snippet a { 
    padding: 0.6rem 1rem;
    text-decoration: none;
    color: var(--output-secondary-text);
    border-right: 1px solid var(--output-accent-color);
    transition: all 0.3s ease;
    cursor: pointer;
}
.content-pane-snippet { 
    display: none;
    padding: 1rem 0;
    line-height: 1.6;
}
#pane-1-snippet { display: block; } 
</style>

<div class="tabs-snippet-container">
<nav class="tabs-snippet">`;
                
                titles.forEach((title, i) => {
                    snippet += `\n    <a href="#pane-${i+1}-snippet" onclick="event.preventDefault(); document.querySelectorAll('.content-pane-snippet').forEach(p => p.style.display='none'); document.getElementById('pane-${i+1}-snippet').style.display='block';">${title}</a>`;
                });
                
                snippet += '\n</nav>\n';
                
                contents.forEach((content, i) => {
                    snippet += `\n<section id="pane-${i+1}-snippet" class="content-pane-snippet" style="${i > 0 ? 'display: none;' : ''}">\n`;
                    snippet += `${marked.parse(content)}\n`;
                    snippet += `</section>\n`;
                });
                snippet += `\n</div>\n`;

            } else if (type === 'query-trigger') {
                const query = document.getElementById('trigger-query').value.trim();
                const text = document.getElementById('trigger-text').value.trim() || query;
                
                snippet = `<style>
.query-trigger { 
    display: inline-block;
    padding: 0.5rem 1rem;
    background: var(--output-accent-color);
    color: var(--output-bg-color);
    font-family: 'Merriweather', serif;
    text-decoration: none;
    border-radius: 3px;
    transition: all 0.2s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    cursor: pointer;
}
.query-trigger:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}
</style>

<a href="https://justice.ai-n.workers.dev/api/ai?q=${encodeURIComponent(query)}" class="query-trigger">
    ${text}
</a>`;
            } else if (type === 'constellation') {
                const title = document.getElementById('constellation-title').value.trim() || 'Core Principles';
                const nodes = document.getElementById('constellation-nodes').value.split(',').map(n => n.trim()).filter(n => n);
                
                if (nodes.length === 0) {
                    showStatus(saveMsg, "Constellation requires at least one node.", 'error');
                    return;
                }

                snippet = `<style>
.constellation-widget {
    font-family: 'Merriweather', serif;
    position: relative;
    height: 350px;
    width: 100%;
    margin: 1.5rem 0;
    border: 1px solid var(--output-accent-color);
    border-radius: 12px;
    background: var(--output-bg-color);
    overflow: hidden;
}
.constellation-title {
    text-align: center;
    font-size: 1.3rem;
    padding: 1rem 0;
    color: var(--output-accent-color);
    border-bottom: 1px solid var(--output-secondary-text);
}
.constellation-node {
    position: absolute;
    background: var(--output-accent-color);
    color: var(--output-bg-color);
    width: 90px;
    height: 90px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 0.5rem;
    box-sizing: border-box;
    font-size: 0.85rem;
    font-weight: 700;
    transition: all 0.3s;
    cursor: pointer;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
}
.constellation-node:hover {
    transform: scale(1.05);
    background: var(--output-text-color);
    color: var(--output-bg-color);
}
</style>

<div class="constellation-widget">
    <div class="constellation-title">${title}</div>
    <div style="position: relative; height: 300px;">`;
                
                const positions = [
                    { x: 10, y: 15 }, { x: 80, y: 25 }, { x: 25, y: 70 },
                    { x: 65, y: 60 }, { x: 45, y: 35 }, { x: 8, y: 65 }
                ];

                nodes.slice(0, 6).forEach((node, i) => {
                    const pos = positions[i % positions.length];
                    snippet += `\n        <div class="constellation-node" style="left:${pos.x}%; top:${pos.y}%">${node}</div>`;
                });
                
                snippet += `\n    </div>\n</div>\n`;
            } else {
                 showStatus(saveMsg, "Dossier snippet generation is not yet implemented.", 'warning');
                 return;
            }
            
            // FIX: Added defensive check for hljs
            let highlighted = `<code>${snippet}</code>`;
            if (typeof hljs !== 'undefined' && hljs.highlight) {
                highlighted = hljs.highlight(snippet, { language: 'html' }).value;
            }
            micrositeCode.innerHTML = highlighted;
            showStatus(saveMsg, "Microsite snippet generated!", 'success');
        });
        
        copyMicrositeBtn.addEventListener('click', () => {
            const snippet = micrositeCode.textContent;
            navigator.clipboard.writeText(snippet).then(() => {
                showStatus(saveMsg, "Microsite snippet copied to clipboard!");
            }).catch(err => {
                showStatus(saveMsg, "Copy failed: " + err.message, 'error');
            });
        });

        // ================================================================================
        // === SECTION 5: QUERY LIBRARY LOGIC (MOCK DATA) ===
        // ================================================================================

        const mockTruths = [
            {id: 'truth-1', query: 'What is the meaning of life?', answer: 'The meaning of life is modularity, transparency, and eternal recursion.', editor: 'archivist', date: '2023-10-25', citations: [{title: "Modularity Principle", url: "https://example.com/modularity"}]},
            {id: 'truth-2', query: 'How does the Truth Engine work?', answer: 'The Truth Engine operates on a distributed ledger system verified by melodic proof-of-work.', editor: 'AI-Generated', date: '2023-11-01', citations: []},
            {id: 'truth-3', query: 'Property management best practices', answer: 'In the digital domain, property is defined by cryptographic key ownership and secure, decentralized indexing.', editor: 'tenant-x', date: '2023-10-20', citations: [{title: "Key Ownership Protocol", url: "https://example.com/keys"}, {title: "Decentralized Indexing", url: "https://example.com/index"}]},
        ];

        let selectedTruth = null;

        function renderTruthLibrary(filter = '') {
            const listEl = document.getElementById('truth-list');
            listEl.innerHTML = '';
            
            const filtered = mockTruths.filter(t => 
                t.query.toLowerCase().includes(filter.toLowerCase()) || 
                t.answer.toLowerCase().includes(filter.toLowerCase())
            );

            if (filtered.length === 0) {
                listEl.innerHTML = '<li style="list-style:none;">No truths found matching your search.</li>';
                return;
            }

            filtered.forEach(truth => {
                const li = document.createElement('li');
                li.style.listStyle = 'none';
                li.style.padding = '8px 0';
                li.style.borderBottom = '1px solid rgba(212, 196, 168, 0.1)';
                li.innerHTML = `<a href="#" data-id="${truth.id}" class="truth-item" style="color: var(--text-color); text-decoration: none;">${truth.query}</a> <span class="content-length" style="float: right;">(by ${truth.editor})</span>`;
                listEl.appendChild(li);
            });

            document.querySelectorAll('.truth-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const id = e.target.dataset.id;
                    const truth = mockTruths.find(t => t.id === id);
                    if (truth) {
                        selectTruth(truth);
                    }
                });
            });
        }

        function selectTruth(truth) {
            selectedTruth = truth;
            document.getElementById('library-truth-title').textContent = truth.query;
            document.getElementById('library-truth-content').innerHTML = marked.parse(truth.answer);
            document.getElementById('load-library-btn').disabled = false;
        }

        document.getElementById('library-search').addEventListener('input', (e) => {
            renderTruthLibrary(e.target.value);
        });

        document.getElementById('load-library-btn').addEventListener('click', () => {
            if (selectedTruth) {
                queryInput.value = selectedTruth.query;
                answerInput.value = selectedTruth.answer;
                editorInput.value = selectedTruth.editor;

                // Clear citations first
                citationTitles.forEach(e => e.value = '');
                citationUrls.forEach(e => e.value = '');

                // Populate citations
                if (selectedTruth.citations) {
                    selectedTruth.citations.slice(0, 2).forEach((c, i) => {
                        citationTitles[i].value = c.title || '';
                        citationUrls[i].value = c.url || '';
                    });
                }
                answerInput.dispatchEvent(new Event('input')); 
                switchTab('query');
                showStatus(saveMsg, `Loaded "${selectedTruth.query}" into editor.`, 'success');
            }
        });

        // Initialize lists and handlers
        window.addEventListener('DOMContentLoaded', () => {
            renderTruthLibrary();
        });


        // ================================================================================
        // === SECTION 6: INITIALIZATION AND EVENT WIRING ===
        // ================================================================================
        
        // Character count wiring (must be done after DOM load)
        answerInput.addEventListener('input', () => {
            const count = answerInput.value.length;
            charCount.textContent = `Character count: ${count}`;
            if (count > 8000) { charCount.classList.add('warning'); } else { charCount.classList.remove('warning'); }
            answerInput.style.height = 'auto';
            answerInput.style.height = Math.min(answerInput.scrollHeight, 350) + 'px';
            updatePreview();
        });

        // Other event wirings
        document.getElementById('back-to-edit-btn').addEventListener('click', () => { switchTab('query'); });
        
        function initializeEditor() {
            const lastEditor = localStorage.getItem('lastEditorName');
            if (lastEditor) editorInput.value = lastEditor;
            answerInput.dispatchEvent(new Event('input'));
        }

        
        // Run initial load functions (called after security check)
        window.onload = function() {
            renderGrid();
            initialUnlockCheck();

            document.querySelectorAll('#main-tabs a').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // FIX: Added specific click listener for nested tabs in the Snippets pane
            document.querySelectorAll('#snippets .tab-buttons button').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('#snippets .tab-buttons button').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    document.getElementById('preview-snippet-tab').style.display = 'none';
                    document.getElementById('analysis-snippet-tab').style.display = 'none';
                    document.getElementById('snippets-extract-tab').style.display = 'none';
                    
                    document.getElementById(e.target.dataset.tab).style.display = 'block';
                });
            });


            document.getElementById('analysis-snippet-tab').style.display = 'none';
            document.getElementById('snippets-extract-tab').style.display = 'none';
            
            document.body.setAttribute('data-output-mode', 'silvery');
        }

    </script>
</body>
</html>

